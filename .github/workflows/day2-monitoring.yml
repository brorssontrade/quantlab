name: Day 2 Production Monitoring

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'production'

jobs:
  day2-checks:
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest pandas numpy

      - name: Fail if secrets not configured
        env:
          PROD_API_BASE_URL: ${{ secrets.PROD_API_BASE_URL }}
          STAGING_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          # Legacy fallback support
          PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}
          STAGING_BASE_URL: ${{ secrets.STAGING_BASE_URL }}
        run: |
          # Check for new-style secrets first, then legacy
          if [ -z "$PROD_API_BASE_URL" ] && [ -z "$STAGING_API_BASE_URL" ] && [ -z "$PROD_BASE_URL" ] && [ -z "$STAGING_BASE_URL" ]; then
            echo "ERROR: No API URL secrets are configured."
            echo "Please add PROD_API_BASE_URL and/or STAGING_API_BASE_URL to GitHub Settings > Secrets."
            echo "(Legacy PROD_BASE_URL/STAGING_BASE_URL also supported for backwards compatibility)"
            exit 1
          fi

      - name: Run Day 2 checks
        env:
          PROD_API_BASE_URL: ${{ secrets.PROD_API_BASE_URL }}
          STAGING_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          # Legacy fallback
          PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}
          STAGING_BASE_URL: ${{ secrets.STAGING_BASE_URL }}
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            if [ -n "$PROD_API_BASE_URL" ]; then
              export PROD_API_BASE_URL="$PROD_API_BASE_URL"
            elif [ -n "$PROD_BASE_URL" ]; then
              export PROD_BASE_URL="$PROD_BASE_URL"
            else
              echo "ERROR: Neither PROD_API_BASE_URL nor PROD_BASE_URL secret configured."
              exit 1
            fi
          else
            if [ -n "$STAGING_API_BASE_URL" ]; then
              export STAGING_API_BASE_URL="$STAGING_API_BASE_URL"
            elif [ -n "$STAGING_BASE_URL" ]; then
              export STAGING_BASE_URL="$STAGING_BASE_URL"
            else
              echo "ERROR: Neither STAGING_API_BASE_URL nor STAGING_BASE_URL secret configured."
              exit 1
            fi
          fi
          python scripts/monitoring/day2_check.py
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: day2-monitoring-reports
          path: docs/verification/DAY2_REPORT.*
          retention-days: 90
      
      - name: Commit reports to main
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          git add -f docs/verification/DAY2_REPORT.*
          git diff --cached --quiet || git commit -m "docs(monitoring): add Day 2 report (production run)"
          git push origin main
        continue-on-error: true
